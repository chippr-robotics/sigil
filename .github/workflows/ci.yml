name: CI

on:
  push:
    branches: [main, "claude/**"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # Format Check
  # ============================================
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        id: fmt_check
        run: |
          if ! cargo fmt --all -- --check; then
            echo "fmt_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ Formatting issues detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "fmt_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… All files are properly formatted" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Apply formatting fixes
        if: steps.fmt_check.outputs.fmt_failed == 'true'
        run: |
          echo "## ðŸ”§ Applying Formatting Fixes" >> $GITHUB_STEP_SUMMARY
          cargo fmt --all
          echo "Formatting fixes applied successfully" >> $GITHUB_STEP_SUMMARY

      - name: Check for changes
        if: steps.fmt_check.outputs.fmt_failed == 'true'
        id: check_changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## ðŸ“ Files Modified" >> $GITHUB_STEP_SUMMARY
            git diff --name-only | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push formatting fixes (non-PR)
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "style: auto-fix formatting with cargo fmt"
          git push
          echo "## âœ… Formatting Fixes Committed" >> $GITHUB_STEP_SUMMARY
          echo "Changes have been automatically committed to the branch." >> $GITHUB_STEP_SUMMARY

      - name: Create PR comment with suggestions (PR only)
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Get the diff
            const diff = execSync('git diff', { encoding: 'utf-8' });
            
            const comment = `## ðŸ”§ Formatting Issues Detected
            
            This PR has formatting issues that can be automatically fixed. Please run the following command locally:
            
            \`\`\`bash
            cargo fmt --all
            \`\`\`
            
            <details>
            <summary>View suggested changes</summary>
            
            \`\`\`diff
            ${diff}
            \`\`\`
            
            </details>
            
            **Note:** These changes will be automatically applied when this PR is merged to a protected branch.`;
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            core.setFailed('Formatting issues detected. Please run `cargo fmt --all` locally.');

      - name: Fail if formatting issues remain
        if: steps.fmt_check.outputs.fmt_failed == 'true' && steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        run: |
          echo "## âŒ Action Required" >> $GITHUB_STEP_SUMMARY
          echo "Please run \`cargo fmt --all\` locally and push the changes." >> $GITHUB_STEP_SUMMARY
          exit 1

  # ============================================
  # Lint Check
  # ============================================
  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-clippy-

      - name: Check Clippy
        id: clippy_check
        run: |
          if ! cargo clippy --workspace --all-targets -- -D warnings; then
            echo "clippy_failed=true" >> $GITHUB_OUTPUT
            echo "âŒ Clippy warnings detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "clippy_failed=false" >> $GITHUB_OUTPUT
            echo "âœ… No clippy warnings found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Apply Clippy fixes
        if: steps.clippy_check.outputs.clippy_failed == 'true'
        run: |
          echo "## ðŸ”§ Attempting Clippy Auto-Fixes" >> $GITHUB_STEP_SUMMARY
          # Use --fix to automatically fix issues, --allow-dirty allows fixing uncommitted changes
          cargo clippy --fix --workspace --all-targets --allow-dirty --allow-staged || true
          echo "Clippy auto-fix completed" >> $GITHUB_STEP_SUMMARY

      - name: Check for changes
        if: steps.clippy_check.outputs.clippy_failed == 'true'
        id: check_changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## ðŸ“ Files Modified by Auto-Fix" >> $GITHUB_STEP_SUMMARY
            git diff --name-only | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No automatic fixes available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify fixes worked
        if: steps.clippy_check.outputs.clippy_failed == 'true'
        id: verify_fixes
        run: |
          if cargo clippy --workspace --all-targets -- -D warnings; then
            echo "fixes_successful=true" >> $GITHUB_OUTPUT
            echo "âœ… All Clippy warnings resolved by auto-fix" >> $GITHUB_STEP_SUMMARY
          else
            echo "fixes_successful=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Some Clippy warnings require manual intervention" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Remaining warnings</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cargo clippy --workspace --all-targets -- -D warnings 2>&1 | head -100 >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Commit and push Clippy fixes (non-PR)
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: auto-fix clippy warnings"
          git push
          echo "## âœ… Clippy Fixes Committed" >> $GITHUB_STEP_SUMMARY
          echo "Changes have been automatically committed to the branch." >> $GITHUB_STEP_SUMMARY

      - name: Create PR comment with auto-fixes (PR only)
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Get the diff
            const diff = execSync('git diff', { encoding: 'utf-8' });
            const fixesSuccessful = '${{ steps.verify_fixes.outputs.fixes_successful }}' === 'true';
            
            let comment = `## ðŸ”§ Clippy Issues Detected\n\n`;
            
            if (fixesSuccessful) {
              comment += `âœ… All issues can be automatically fixed! Run the following command locally:\n\n`;
            } else {
              comment += `âš ï¸ Some issues can be automatically fixed, but manual intervention may be required. Start by running:\n\n`;
            }
            
            comment += `\`\`\`bash
cargo clippy --fix --workspace --all-targets --allow-dirty --allow-staged
\`\`\`\n\n`;
            
            if (diff.length > 0 && diff.length < 10000) {
              comment += `<details>
<summary>View suggested auto-fixes</summary>

\`\`\`diff
${diff}
\`\`\`

</details>\n\n`;
            }
            
            if (!fixesSuccessful) {
              comment += `**Additional Manual Fixes Required:**
After applying auto-fixes, you may need to address remaining warnings manually. Run:

\`\`\`bash
cargo clippy --workspace --all-targets -- -D warnings
\`\`\`

to see remaining issues.\n\n`;
            }
            
            comment += `**Note:** These changes will be automatically applied when this PR is merged to a protected branch.`;
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail if issues remain on PR
        if: steps.clippy_check.outputs.clippy_failed == 'true' && github.event_name == 'pull_request'
        run: |
          echo "## âŒ Action Required" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
            echo "Please run \`cargo clippy --fix --workspace --all-targets --allow-dirty --allow-staged\` locally." >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.verify_fixes.outputs.fixes_successful }}" == "false" ]]; then
            echo "Some warnings require manual fixes. Check the comment above for details." >> $GITHUB_STEP_SUMMARY
          fi
          exit 1

  # ============================================
  # Build Check
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-

      - name: Build all targets
        run: cargo build --workspace --all-targets

      - name: Build release
        run: cargo build --workspace --release

  # ============================================
  # Unit Tests
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      - name: Run unit tests (sigil-core)
        run: cargo test -p sigil-core --lib --verbose

      - name: Run unit tests (sigil-mother)
        run: cargo test -p sigil-mother --lib --verbose

      - name: Run unit tests (sigil-zkvm)
        run: cargo test -p sigil-zkvm --lib --verbose

      - name: Run unit tests (sigil-daemon)
        run: cargo test -p sigil-daemon --lib --verbose

      - name: Run unit tests (sigil-cli)
        run: cargo test -p sigil-cli --lib --verbose

  # ============================================
  # Integration Tests
  # ============================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-

      - name: Run integration tests (sigil-core)
        run: cargo test -p sigil-core --test disk_format_tests --verbose

      - name: Run integration tests (sigil-mother)
        run: cargo test -p sigil-mother --test ceremony_tests --verbose

  # ============================================
  # End-to-End Tests
  # ============================================
  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [integration]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-

      - name: Run E2E tests
        run: cargo test -p sigil-tests --test e2e_workflow_test --verbose

  # ============================================
  # Code Coverage
  # ============================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-

      - name: Generate coverage report
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Documentation
  # ============================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-

      - name: Build documentation
        run: cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # ============================================
  # Security Audit
  # ============================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true # Advisory only

  # ============================================
  # Summary Job
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [fmt, clippy, build, test, integration, e2e, docs]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.integration.result }}" != "success" ]] || \
             [[ "${{ needs.e2e.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI checks passed!"
